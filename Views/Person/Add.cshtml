@model MvcDirectory.Models.PersonModel.PersonAddViewModel

@{
    ViewData["Title"] = "Add";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html>
<head>
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="~/css/cropper.css" />
</head>

<body>
    <section class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h1 class="display-4 font-weight-light text-center">Add New Person</h1>
                    </div>

                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data" asp-action="Add" class="needs-validation" novalidate>
                            <div class="form-group">
                                <label for="name">Name</label>
                                <input asp-for="Person.Name" class="form-control" id="name" required />
                                <div class="invalid-feedback">
                                    Please enter a valid name.
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="phoneNumber">Phone Number</label>
                                <input asp-for="Person.PhoneNumber" class="form-control" id="phoneNumber" required pattern="\d{10,11}" title="Enter a valid phone number (10 or 11 digits)" />
                                <div class="invalid-feedback">
                                    Please enter a valid phone number (10 or 11 digits).
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input asp-for="Person.Email" class="form-control" id="email" type="email" required />
                                <div class="invalid-feedback">
                                    Please enter a valid email address.
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="profilePhoto">Fotoğraf Seçin:</label>
                                <input type="file" id="profilePhoto" name="ProfilePhoto" accept="image/*" class="file-input" />
                            </div>

                            <div class="form-group">
                                <label for="photoPreview">Photo Preview:</label>
                                <div class="photo-preview">
                                    <img id="previewImg" src="#" alt="Photo Preview" style="max-width: 200px; max-height: 200px; display: none; border: 2px solid #ddd; border-radius: 5px; padding: 5px;" />
                                    <p id="noImageMsg" style="display: block; text-align: center; font-weight: bold; color: #808080;">No photo selected</p>
                                </div>
                            </div>

                            <!-- Add this container to hold the image for cropping -->
                            <div id="cropperContainer" style="display: none;">
                                <img id="cropperImage" src="#" alt="Crop Image" />
                            </div>

                            <!-- Add buttons for actions: choose image and crop -->
                            <div class="form-group">
                                <div class="btn-group">
                                    <button type="button" id="cropButton" class="btn btn-primary" disabled>Crop Image</button>
                                </div>
                            </div>

                            <!-- Add a hidden input to store the cropped image data to be sent to the server -->
                            <input type="hidden" id="croppedImage" name="CroppedImage" />

                            <div class="form-group text-center">
                                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">Return</a>
                                <a href="@Url.Action("Read", "Person")" class="btn btn-primary btn-md add-button" style="background-color: #808080;">Read From Card</a>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    @section Scripts {

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="~/js/cropper.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var image = document.getElementById("previewImg");
                var noImageMsg = document.getElementById("noImageMsg");
                var cropperContainer = document.getElementById("cropperContainer");
                var cropperImage = document.getElementById("cropperImage");
                var cropper;

                var currentImage = null;

                document.getElementById("fileInput").addEventListener("change", function (event) {
                    var input = event.target;
                    var file = input.files[0];
                    if (file) {
                        var reader = new FileReader();
                        reader.onload = function () {
                            if (currentImage) {
                                currentImage.remove();
                            }

                            image.style.display = "block";
                            noImageMsg.style.display = "none";
                            image.src = URL.createObjectURL(file);
                            cropperContainer.style.display = "block";
                            cropperImage.src = URL.createObjectURL(file);
                            cropper = new Cropper(cropperImage, {
                                aspectRatio: 1,
                                viewMode: 2,
                            });
                            currentImage = cropperImage;
                            document.getElementById("cropButton").removeAttribute("disabled");
                        };
                        reader.readAsDataURL(file);
                    } else {
                        image.src = "/images/default.jpg";
                        cropperContainer.style.display = "none";
                        document.getElementById("cropButton").setAttribute("disabled", "disabled");
                    }
                });

                document.getElementById("cropButton").addEventListener("click", function () {
                    cropper.crop();

                    var croppedImageData = cropper.getCroppedCanvas().toDataURL();
                    document.getElementById("croppedImage").value = croppedImageData;

                    // Show the cropped image preview in the `previewImg` element
                    image.src = croppedImageData;
                });
            });
        </script>
        }

    }
</body>
</html>
